# Migration Reset Guide

## Overview
This guide documents the process of removing all existing migrations and creating a fresh initial migration that includes all current schema changes, including the new Aadhar number field.

## Process Completed

### 1. Removed All Existing Migrations
- **Action**: Deleted all migration files from the `Migrations` directory
- **Files Removed**: All `.cs` migration files including:
  - `20250801124621_InitialMigration.cs`
  - `20250801125516_AddLoanTermColumn.cs`
  - `20250802054944_AddDescriptionToLoanRequest.cs`
  - `20250802075050_AddChequeNumberToLoanRequest.cs`
  - `20250803042932_AddPresidentAndTreasurerRoles.cs`
  - `20250803043723_AddUserActivityTable.cs`
  - `20250803045942_AddUserStatusAndMeetingMinutesFields.cs`
  - `20250803071025_AddAadharNumberToUser.cs`

### 2. Dropped Database
- **Action**: Completely dropped the existing database
- **Command**: `dotnet ef database drop --force`
- **Result**: Clean slate for fresh migration

### 3. Created Fresh Initial Migration
- **Action**: Generated new initial migration
- **Command**: `dotnet ef migrations add InitialMigration`
- **Result**: Single migration file containing all current schema

### 4. Applied New Migration
- **Action**: Applied the fresh migration to create database
- **Command**: `dotnet ef database update`
- **Result**: Database created with complete schema

## New Migration Details

### Migration File
- **Name**: `20250803075212_InitialMigration.cs`
- **Size**: 22KB (444 lines)
- **Contains**: Complete database schema in single migration

### Tables Created
1. **LoanTypes** - Loan type definitions
2. **Meetings** - Meeting information
3. **UserRoles** - User role definitions
4. **Users** - User information (includes AadharNumber field)
5. **Attendances** - Meeting attendance records
6. **LoanRequests** - Loan request applications
7. **Loans** - Active loans
8. **MeetingPayments** - Meeting payment records
9. **UserActivities** - User activity logging
10. **UserLogins** - User authentication credentials

### Key Features Included
- **Aadhar Number Field**: `AadharNumber` column in Users table (12 characters max)
- **Soft Delete Support**: `IsActive` and `InactiveDate` fields in Users table
- **All Relationships**: Foreign keys and constraints
- **Indexes**: Performance optimization indexes
- **Seed Data**: Initial loan types, user roles, and default secretary user

## Database Schema Highlights

### Users Table
```sql
CREATE TABLE "Users" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(100) NOT NULL,
    "Address" character varying(200) NOT NULL,
    "Email" character varying(100) NOT NULL,
    "Phone" character varying(20) NOT NULL,
    "AadharNumber" character varying(12) NOT NULL,
    "IsActive" boolean NOT NULL,
    "InactiveDate" timestamp without time zone NULL,
    "JoiningDate" timestamp without time zone NULL,
    "UserRoleId" integer NOT NULL,
    CONSTRAINT "PK_Users" PRIMARY KEY ("Id")
);
```

### Seed Data
- **Loan Types**: Marriage Loan (1.16%), Personal Loan (2.5%)
- **User Roles**: Secretary, President, Treasurer, Member
- **Default User**: Secretary account for initial access

## Benefits of Migration Reset

### 1. Clean Migration History
- **Single Migration**: All schema changes in one file
- **No Migration Conflicts**: Eliminates potential migration conflicts
- **Easier Maintenance**: Simpler migration management

### 2. Complete Schema
- **All Features**: Includes all current features and fields
- **Aadhar Number**: Properly integrated from the start
- **Soft Delete**: User deactivation functionality included
- **Activity Logging**: User activity tracking included

### 3. Performance Optimized
- **Proper Indexes**: All necessary indexes included
- **Constraints**: Data integrity constraints in place
- **Relationships**: All foreign key relationships defined

## Current State

### Database Status
- **Database**: `phoenixlatest` (PostgreSQL)
- **Migration Applied**: `20250803075212_InitialMigration`
- **Schema**: Complete with all features
- **Data**: Seed data populated

### API Status
- **All Endpoints**: Working with Aadhar number support
- **User Management**: Full CRUD operations
- **Soft Delete**: User deactivation functionality
- **Authentication**: Login with active status check

## Verification Steps

### 1. Database Verification
```sql
-- Check if AadharNumber column exists
SELECT column_name, data_type, character_maximum_length 
FROM information_schema.columns 
WHERE table_name = 'Users' AND column_name = 'AadharNumber';

-- Check if all tables exist
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';
```

### 2. API Verification
- Test user creation with Aadhar number
- Test user update with Aadhar number
- Test user listing (should include Aadhar number)
- Test soft delete functionality
- Test login with inactive user

### 3. Migration Status
```bash
dotnet ef migrations list
dotnet ef database update
```

## Future Migrations

### Adding New Features
When adding new features in the future:
1. **Modify Models**: Update entity models as needed
2. **Create Migration**: `dotnet ef migrations add MigrationName`
3. **Apply Migration**: `dotnet ef database update`

### Migration Best Practices
- **Descriptive Names**: Use clear, descriptive migration names
- **Test Migrations**: Test migrations in development first
- **Backup Data**: Backup production data before applying migrations
- **Rollback Plan**: Have a rollback strategy for production

## Troubleshooting

### Common Issues
1. **Migration Conflicts**: If conflicts occur, consider another reset
2. **Data Loss**: Always backup before major migration changes
3. **Connection Issues**: Ensure database connection is working
4. **Permission Issues**: Ensure proper database permissions

### Rollback Options
If needed, the current migration can be rolled back:
```bash
dotnet ef database update 0
dotnet ef migrations remove
```

## Summary

The migration reset process has been completed successfully. The database now has:
- ✅ Clean migration history (single migration)
- ✅ Complete schema with all features
- ✅ Aadhar number field properly integrated
- ✅ Soft delete functionality
- ✅ All relationships and constraints
- ✅ Seed data for initial setup
- ✅ Performance optimized with proper indexes

The system is ready for production use with all current features including the Aadhar number field. 